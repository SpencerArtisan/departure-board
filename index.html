<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Hello React!</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.0.1/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.0.1/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.5/marked.min.js"></script>

  </head>
  <body>
    <h1>Cally S</h1>
    <div id="callySouth"></div>

    <h1>Cally N</h1>
    <div id="callyNorth"></div>

    <h1>Hemingford S</h1>
    <div id="hemingfordSouth"></div>

    <h1>Overground E</h1>
    <div id="overgroundEast"></div>

    <h1>Overground W</h1>
    <div id="overgroundWest"></div>

    <script type="text/babel">
var Departure = React.createClass({
  render: function() {
    return (
      <div>
        {this.props.children}
      </div>
    );
  }
});

var Departures = React.createClass({
  render: function() {
    var lineId = this.props.lineId;
    console.log("LINE " + lineId + " state at " + new Date());
    var departureNodes = this.props.data.map(function(departure) {
      var arrival = new Date(departure.expectedArrival)
      var minsToArrival = Math.round((arrival - new Date())/60000);
      console.log(minsToArrival+"m to " + arrival);
      if (departure.lineId != lineId || minsToArrival < 0) return (<div/>);
      var display = minsToArrival == 0 ? "due" : minsToArrival;
      return (
        <Departure>
          {display}
        </Departure>
      );
    });
    return (
      <div>
        <h1>{this.props.lineId}</h1>
        {departureNodes}
      </div>
    );
  }
});

var StopBox = React.createClass({
  loadStopsFromServer: function() {
    $.ajax({
      url: this.props.url,
      dataType: 'json',
      cache: false,
      success: function(data) {
        this.setState({data: data});
      }.bind(this),
      error: function(xhr, status, err) {
        console.error(this.props.url, status, err.toString());
      }.bind(this)
    });
  },
  getInitialState: function() {
    return {data: []};
  },
  componentDidMount: function() {
    this.loadStopsFromServer();
    setInterval(this.loadStopsFromServer, this.props.pollInterval);
  },
  render: function() {
    var dat=this.state.data
    var departureNodes = this.props.lineIds.map(function(lineId) {
      return (
      <Departures lineId={lineId} data={dat}/>
      );
    });
    return (
      <div>
        {departureNodes}
      </div>
    );
  }
});

ReactDOM.render(
<StopBox url='https://api.tfl.gov.uk/StopPoint/490001043L/Arrivals' lineIds={['17','91', '274', '259']} pollInterval={2000}/>,
  document.getElementById('callySouth')
  );
ReactDOM.render(
<StopBox url='https://api.tfl.gov.uk/StopPoint/490001043K/Arrivals' lineIds={['274']} pollInterval={2000}/>,
  document.getElementById('callyNorth')
);
ReactDOM.render(
<StopBox url='https://api.tfl.gov.uk/StopPoint/490013415S/Arrivals' lineIds={['153']} pollInterval={2000}/>,
  document.getElementById('hemingfordSouth')
);

    </script>
  </body>
</html>

