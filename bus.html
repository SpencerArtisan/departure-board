<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" type="text/css" href="bus.css">
    <meta charset="UTF-8" />
    <title>Hello React!</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.0.1/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.0.1/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.5/marked.min.js"></script>
</head>
<body>
  <ol class="stops">
    <li class="bus stop" id="callySouth"></li>
    <li class="bus stop" id="callyNorth"></li>
    <li class="bus stop" id="hemingfordSouth"></li>
  </ol>

    <script type="text/babel">
var Departure = React.createClass({
  render: function() {
      return this.props.minsToArrival == 0 ? 
      (<li><span className="value">due</span></li>) : 
      (<li><span className="value">{this.props.minsToArrival}</span><span className="units">mins</span></li>);
  }
});

var Departures = React.createClass({
  render: function() {
    var lineId = this.props.lineId;
    console.log("LINE " + lineId + " state at " + new Date());
    var departureNodes = [];
    this.props.data.sort(function(a,b){return a.timeToStation-b.timeToStation}).forEach(function(departure) {
      var arrival = new Date(departure.expectedArrival)
      var minsToArrival = Math.round((arrival - new Date())/60000);
      console.log(minsToArrival+"m to " + arrival);
      if (departure.lineId != lineId || minsToArrival < 0 || departureNodes.length==3) return;
      departureNodes.push(<Departure minsToArrival={minsToArrival}/>);
    });
    return (
      <li className="unit">
        <span className="unitName">{this.props.lineId}</span>
		<ol className="departures">
        {departureNodes}
        </ol>
        <span className="route">{this.props.route}</span>				
      </li>
    );
  }
});

var StopBox = React.createClass({
  loadStopsFromServer: function() {
    $.ajax({
      url: this.props.url,
      dataType: 'json',
      cache: false,
      success: function(data) {
        this.setState({data: data});
      }.bind(this),
      error: function(xhr, status, err) {
        console.error(this.props.url, status, err.toString());
      }.bind(this)
    });
  },
  getInitialState: function() {
    return {data: []};
  },
  componentDidMount: function() {
    this.loadStopsFromServer();
    setInterval(this.loadStopsFromServer, this.props.pollInterval);
  },
  render: function() {
    var dat=this.state.data
    var departureNodes = this.props.lineIds.map(function(lineId) {
      var split = lineId.split(":");
      return (
      <Departures lineId={split[0]} route={split[1]} data={dat}/>
      );
    });
    return (
    <div>
      <span className="stopName">{this.props.label}</span>
	  <ol className="units">
        {departureNodes}
      </ol>
    </div>
    );
  }
});

ReactDOM.render(
<StopBox url='https://api.tfl.gov.uk/StopPoint/490001043L/Arrivals' label="Cally S" 
         lineIds={[
          "17:⇢ King's Cross ⇢ Clerkenwell ⇢ Cannon St",
          "91:⇢ King's Cross ⇢ Holborn ⇢ Charing Cross", 
          "274:⇢ Angel", 
          "259:⇢ King's Cross"]} 
        pollInterval={2000}/>,
  document.getElementById('callySouth')
  );
ReactDOM.render(
<StopBox url='https://api.tfl.gov.uk/StopPoint/490001043K/Arrivals' label="Cally N" 
         lineIds={['274:⇢ Camden ⇢ Baker St ⇢ Mayfair']} pollInterval={2000}/>,
  document.getElementById('callyNorth')
);
ReactDOM.render(
<StopBox url='https://api.tfl.gov.uk/StopPoint/490013415S/Arrivals' label="Hemingford S" 
         lineIds={['153:⇢ Angel ⇢ Clerkenwell ⇢ Liverpool St']} pollInterval={2000}/>,
  document.getElementById('hemingfordSouth')
);
    </script>
  </body>
</html>
